name: Release

on:
  push:
    tags:
      - 'v*'

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  ALL_MODULES: "MIDI2Core MIDI2Transport MIDI2CI MIDI2PE MIDI2Kit"

jobs:
  # ─── Job 1: Run tests ───
  test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app \
            || sudo xcode-select -s /Applications/Xcode_16.3.app \
            || sudo xcode-select -s /Applications/Xcode_16.2.app \
            || sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Show versions
        run: |
          xcodebuild -version
          swift --version

      - name: Run tests
        run: swift test

  # ─── Job 2: Build XCFrameworks ───
  build-xcframework:
    needs: test
    runs-on: macos-15
    outputs:
      checksums: ${{ steps.checksums.outputs.json }}
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app \
            || sudo xcode-select -s /Applications/Xcode_16.3.app \
            || sudo xcode-select -s /Applications/Xcode_16.2.app \
            || sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Build XCFrameworks
        run: bash Scripts/build-xcframework.sh

      - name: Verify all ZIPs exist
        run: |
          for MODULE in $ALL_MODULES; do
            if [ ! -f "dist/${MODULE}.xcframework.zip" ]; then
              echo "ERROR: dist/${MODULE}.xcframework.zip not found"
              exit 1
            fi
            echo "OK: dist/${MODULE}.xcframework.zip ($(du -h "dist/${MODULE}.xcframework.zip" | cut -f1))"
          done

      - name: Compute checksums
        id: checksums
        run: |
          JSON="{"
          FIRST=true
          for MODULE in $ALL_MODULES; do
            CHECKSUM=$(swift package compute-checksum "dist/${MODULE}.xcframework.zip")
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON="${JSON},"
            fi
            JSON="${JSON}\"${MODULE}\":\"${CHECKSUM}\""
          done
          JSON="${JSON}}"
          echo "json=${JSON}" >> "$GITHUB_OUTPUT"
          echo "Checksums: ${JSON}"

      - name: Upload XCFramework artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xcframeworks
          path: dist/*.xcframework.zip
          retention-days: 1

  # ─── Job 3: Create release on MIDI2Kit-SDK ───
  create-sdk-release:
    needs: build-xcframework
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: xcframeworks
          path: dist

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Release tag: ${TAG}"

      - name: Create release on MIDI2Kit-SDK
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          # Create release with all zip files
          gh release create "${TAG}" \
            --repo midi2kit/MIDI2Kit-SDK \
            --title "MIDI2Kit ${TAG}" \
            --notes "Automated release from hakaru/MIDI2Kit ${TAG}" \
            dist/*.xcframework.zip

      - name: Verify release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          gh release view "${TAG}" --repo midi2kit/MIDI2Kit-SDK

  # ─── Job 4: Dispatch updates to SDK and docs repos ───
  dispatch-updates:
    needs: [build-xcframework, create-sdk-release]
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Dispatch to MIDI2Kit-SDK (update Package.swift)
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          CHECKSUMS='${{ needs.build-xcframework.outputs.checksums }}'

          gh api repos/midi2kit/MIDI2Kit-SDK/dispatches \
            --method POST \
            -f "event_type=update-package" \
            -f "client_payload={\"version\":\"${TAG}\",\"checksums\":${CHECKSUMS}}"

      - name: Dispatch to midi2kit.github.io (update docs)
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          gh api repos/midi2kit/midi2kit.github.io/dispatches \
            --method POST \
            -f "event_type=update-docs" \
            -f "client_payload={\"version\":\"${TAG}\"}"
