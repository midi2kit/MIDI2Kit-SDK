name: Release Consumer Smoke

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "SemVer version to validate (without leading v, e.g. 1.0.14)"
        required: false
        type: string

jobs:
  consumer-smoke:
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app \
            || sudo xcode-select -s /Applications/Xcode_16.3.app \
            || sudo xcode-select -s /Applications/Xcode_16.2.app \
            || sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Show toolchain versions
        run: |
          xcodebuild -version
          swift --version

      - name: Resolve release version
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ -n "${INPUT_VERSION}" ]; then
            VERSION="${INPUT_VERSION}"
          elif [ "${EVENT_NAME}" = "release" ] && [ -n "${RELEASE_TAG}" ]; then
            VERSION="${RELEASE_TAG#v}"
          else
            echo "Unable to determine version." >&2
            exit 1
          fi

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Resolved version: ${VERSION}"

      - name: Build consumer smoke package
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          WORKDIR="$(mktemp -d)"
          echo "Using temp dir: ${WORKDIR}"
          cd "${WORKDIR}"

          cat > Package.swift <<EOF
          // swift-tools-version: 6.0
          import PackageDescription

          let package = Package(
              name: "midi2kit-sdk-consumer-smoke",
              platforms: [.macOS(.v14)],
              dependencies: [
                  .package(url: "https://github.com/midi2kit/MIDI2Kit-SDK.git", exact: "${VERSION}")
              ],
              targets: [
                  .executableTarget(
                      name: "midi2kit-sdk-consumer-smoke",
                      dependencies: [
                          .product(name: "MIDI2Kit", package: "MIDI2Kit-SDK")
                      ]
                  )
              ]
          )
          EOF

          mkdir -p Sources/midi2kit-sdk-consumer-smoke
          cat > Sources/midi2kit-sdk-consumer-smoke/main.swift <<'EOF'
          import Foundation
          import MIDI2Kit

          @main
          struct SmokeApp {
              static func main() throws {
                  let legacyCurrentValueJSON = """
                  {
                    "controlcc": 7,
                    "value": 100,
                    "name": "Volume",
                    "displayValue": "100",
                    "displayUnit": ""
                  }
                  """

                  let value = try JSONDecoder().decode(PEXCurrentValue.self, from: Data(legacyCurrentValueJSON.utf8))
                  guard value.controlCC == 7,
                        value.value == .int(100),
                        value.name == "Volume",
                        value.displayValue == "100",
                        value.displayUnit == "" else {
                      fatalError("PEXCurrentValue decode failed: \(value)")
                  }

                  let programDefJSON = """
                  {
                    "title": "Grand Piano",
                    "bankPC": [0, 1, 48]
                  }
                  """

                  let program = try JSONDecoder().decode(PEProgramDef.self, from: Data(programDefJSON.utf8))
                  guard program.bankMSB == 0,
                        program.bankLSB == 1,
                        program.programNumber == 48,
                        program.name == "Grand Piano" else {
                      fatalError("PEProgramDef decode failed: \(program)")
                  }

                  print("OK: MIDI2Kit-SDK consumer smoke passed")
              }
          }
          EOF

          swift run -v
