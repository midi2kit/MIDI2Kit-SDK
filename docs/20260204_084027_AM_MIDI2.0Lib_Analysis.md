# AM_MIDI2.0Lib 調査レポート

**調査日**: 2026-02-04
**対象リポジトリ**: https://github.com/midi2-dev/AM_MIDI2.0Lib
**バージョン**: 最終更新 2025-12-28

---

## 1. プロジェクト概要

### 基本情報

| 項目 | 内容 |
|------|------|
| **名称** | AM MIDI 2.0 Lib |
| **概要** | MIDI 2.0デバイス・アプリケーション構築用汎用C++ライブラリ |
| **言語** | C++ |
| **ライセンス** | MIT License |
| **作者** | Andrew Mee |
| **GitHub Stars** | 57 |
| **Forks** | 9 |

### 技術スタック

- **ビルドシステム**: CMake / Makefile
- **C++標準**: C++11以上（std::array, std::function, std::map使用）
- **外部依存**: なし（header-onlyスタイルを意識した設計）
- **対象環境**: 組み込みデバイスから大規模アプリケーションまで

### アーキテクチャの特徴

1. **省メモリ設計**
   - UMPパケット単位（32bit）での逐次処理
   - 大きなSysExデータを小さなチャンクで処理
   - コンパイルサイズ: 約10KB、メモリフットプリント: 約1KB

2. **モジュラー構成**
   - 必要な機能のヘッダーだけを取り込み可能
   - MIDI-CIのみ必要ならそのヘッダーだけを使用

3. **コールバックベース設計**
   - std::functionを使用したコールバック登録
   - イベント駆動型の処理フロー

### プロジェクト構造

```
AM_MIDI2.0Lib/
├── include/                    # ヘッダーファイル
│   ├── bytestreamToUMP.h      # MIDI 1.0 → UMP変換
│   ├── umpToBytestream.h      # UMP → MIDI 1.0変換
│   ├── umpProcessor.h         # UMPメッセージ処理
│   ├── umpMessageCreate.h     # UMPメッセージ生成
│   ├── midiCIProcessor.h      # MIDI-CI処理
│   ├── midiCIMessageCreate.h  # MIDI-CIメッセージ生成
│   ├── mcoded7.h              # Mcoded7エンコード/デコード
│   ├── umpToMIDI1Protocol.h   # プロトコル変換
│   ├── umpToMIDI2Protocol.h   # プロトコル変換
│   └── utils.h                # ユーティリティ・定数
├── src/                        # 実装ファイル
├── docs/                       # ドキュメント
├── tests/                      # テストコード
├── CMakeLists.txt
└── Makefile
```

---

## 2. 実装されている機能一覧

### UMP (Universal MIDI Packet) 関連

| 機能 | クラス/ファイル | 説明 |
|------|----------------|------|
| UMP処理 | `umpProcessor` | UMPメッセージのパースとコールバック呼び出し |
| UMPメッセージ生成 | `UMPMessage::*` | MT0-MTF全タイプのメッセージ生成関数 |
| MIDI 1.0→UMP変換 | `bytestreamToUMP` | バイトストリームからUMPへの変換 |
| UMP→MIDI 1.0変換 | `umpToBytestream` | UMPからバイトストリームへの変換 |

### MIDI-CI (Capability Inquiry) 関連

| 機能 | クラス/ファイル | 説明 |
|------|----------------|------|
| MIDI-CI処理 | `midiCIProcessor` | MIDI-CI SysExのパースとコールバック |
| MIDI-CIメッセージ生成 | `CIMessage::*` | 全MIDI-CIメッセージの生成関数 |
| Discovery | 対応済み | 0x70/0x71メッセージ |
| Profile Inquiry | 対応済み | 0x20-0x29, 0x2Fメッセージ |
| Property Exchange | 対応済み | 0x30-0x3Fメッセージ |
| Process Inquiry | 対応済み | 0x40-0x44メッセージ |
| Protocol Negotiation | 対応済み (deprecated) | 0x10-0x15メッセージ |

### 対応UMPメッセージタイプ

| MT | 名称 | サポート状況 |
|----|------|-------------|
| 0x0 | Utility | 完全対応 |
| 0x1 | System Common/Realtime | 完全対応 |
| 0x2 | MIDI 1.0 Channel Voice | 完全対応 |
| 0x3 | 64-bit SysEx | 完全対応 |
| 0x4 | MIDI 2.0 Channel Voice | 完全対応 |
| 0x5 | 128-bit Data (MDS) | 対応済み |
| 0xD | Flex Data | 対応済み |
| 0xF | UMP Stream | 完全対応 |

---

## 3. MIDI-CI / Property Exchange / UMP実装詳細

### 3.1 MIDI-CI実装 (midiCIProcessor)

#### 構造体定義

```cpp
struct MIDICI {
    uint8_t umpGroup;       // UMPグループ（0-based）
    uint8_t deviceId;       // 0x00-0x0F: CH 1-16, 0x7E: Group, 0x7F: Function Block
    uint8_t ciType;         // MIDI-CIメッセージタイプ
    uint8_t ciVer;          // CIバージョン (0x1: v1.1, 0x2: v1.2)
    uint32_t remoteMUID;    // リモートMUID
    uint32_t localMUID;     // ローカルMUID
    uint8_t totalChunks;    // PEチャンク総数
    uint8_t numChunk;       // 現在のチャンク番号
    uint8_t requestId;      // Request ID (PE用)
};
```

#### 処理フロー

1. `startSysex7(umpGroup, deviceId)` - SysEx処理開始
2. `processMIDICI(s7Byte)` - バイト単位で処理
3. `endSysex7()` - SysEx処理終了

#### コールバック設計パターン

```cpp
// コールバック登録
midiCIProcessor MIDICIHandler;
MIDICIHandler.setCheckMUID(checkMUIDCallback);
MIDICIHandler.setRecvDiscovery(discoveryCallback);
MIDICIHandler.setRecvDiscoveryReply(discoveryReplyCallback);
// ... 他のコールバック
```

#### 特徴的な実装

- **バイト単位処理**: メモリ効率のため1バイトずつ処理
- **バージョン互換性**: MIDI-CI 1.1/1.2の前方・後方互換性
- **未知バイトの無視**: 理解できないバイトは単に無視

### 3.2 Property Exchange実装

#### PEメッセージ定義

```cpp
#define MIDICI_PE_CAPABILITY       0x30
#define MIDICI_PE_CAPABILITYREPLY  0x31
#define MIDICI_PE_GET              0x34
#define MIDICI_PE_GETREPLY         0x35
#define MIDICI_PE_SET              0x36
#define MIDICI_PE_SETREPLY         0x37
#define MIDICI_PE_SUB              0x38
#define MIDICI_PE_SUBREPLY         0x39
#define MIDICI_PE_NOTIFY           0x3F
```

#### PEステータスコード

```cpp
#define MIDICI_PE_STATUS_OK                   200
#define MIDICI_PE_STATUS_ACCEPTED             202
#define MIDICI_PE_STATUS_BAD_REQ              400
#define MIDICI_PE_STATUS_REQ_UNAUTHORIZED     403
#define MIDICI_PE_STATUS_RESOURCE_UNSUPPORTED 404
#define MIDICI_PE_STATUS_INTERNAL_DEVICE_ERROR 500
// ... 他多数
```

#### PEコマンド定義

```cpp
#define MIDICI_PE_COMMAND_START   1
#define MIDICI_PE_COMMAND_END     2
#define MIDICI_PE_COMMAND_PARTIAL 3
#define MIDICI_PE_COMMAND_FULL    4
#define MIDICI_PE_COMMAND_NOTIFY  5
```

#### PEエンコーディング

```cpp
#define MIDICI_PE_ASCII      1
#define MIDICI_PE_MCODED7    2
#define MIDICI_PE_MCODED7ZLIB 3
```

### 3.3 UMP処理実装 (umpProcessor)

#### 構造体定義

```cpp
// チャンネルボイスメッセージ
struct umpCVM {
    uint8_t umpGroup;
    uint8_t messageType;
    uint8_t status;
    uint8_t channel;
    uint8_t note;
    uint32_t value;
    uint16_t index;
    uint8_t bank;
    bool flag1;
    bool flag2;
};

// データメッセージ
struct umpData {
    uint8_t umpGroup;
    uint8_t messageType;
    uint8_t streamId;
    uint8_t status;
    uint8_t form;
    uint8_t* data;
    uint8_t dataLength;
};

// Flex Data
struct umpFlexData {
    uint8_t umpGroup;
    uint8_t channel;
    uint8_t messageType;
    uint8_t status;
    uint8_t statusBank;
    uint8_t form;
    uint8_t addrs;
    uint32_t* data;
};
```

#### 処理メソッド

```cpp
void processUMP(uint32_t UMP);  // 32bit単位でUMP処理
void clearUMP();               // 処理状態リセット
```

### 3.4 値スケーリング実装

```cpp
// 7bit → 16/32bit スケールアップ
inline uint32_t scaleUp(uint32_t srcVal, uint8_t srcBits, uint8_t dstBits) {
    if(srcVal == 0) return 0L;
    if(srcBits == 1) return (1 << dstBits) - 1L;

    uint8_t scaleBits = (dstBits - srcBits);
    uint32_t bitShiftedValue = (srcVal + 0L) << scaleBits;
    uint32_t srcCenter = 1 << (srcBits-1);
    if (srcVal <= srcCenter) return bitShiftedValue;

    // expanded bit repeat scheme
    uint8_t repeatBits = srcBits - 1;
    auto repeatMask = (1 << repeatBits) - 1;
    uint32_t repeatValue = srcVal & repeatMask;
    // ... ビット反復処理
}

// スケールダウン
inline uint32_t scaleDown(uint32_t srcVal, uint8_t srcBits, uint8_t dstBits) {
    return srcVal >> (srcBits - dstBits);
}
```

### 3.5 Mcoded7実装

```cpp
// デコード
class mcoded7Decode {
    uint8_t dump[7];
    void parseS7Byte(uint8_t s7Byte) {
        if (dumpPos == 255) {
            reset();
            bits = s7Byte;  // 最初のバイトはビットマップ
            dumpPos = 0;
        } else {
            fBit = ((bits >> (6 - dumpPos)) & 1) << 7;
            dump[dumpPos++] = s7Byte | fBit;
        }
    }
};

// エンコード
class mcoded7Encode {
    uint8_t dump[8];
    void parseByte(uint8_t s8Byte) {
        uint8_t c = s8Byte & 0x7F;
        uint8_t msb = s8Byte >> 7;
        dump[0] |= msb << cnt;
        dump[dumpPos] = c;
        // ...
    }
};
```

---

## 4. MIDI2Kitに参考になる点

### 4.1 設計パターン

#### コールバックベースのイベント処理

```cpp
// AM_MIDI2.0Lib: std::functionコールバック
std::function<void(struct umpCVM mess)> channelVoiceMessage = nullptr;
inline void setCVM(std::function<void(struct umpCVM mess)> fptr) {
    channelVoiceMessage = fptr;
}
```

MIDI2Kitでは Swift Concurrency (async/await) を使用しているが、
イベント駆動部分では同様のコールバックパターンが有効。

#### バイト単位のストリーム処理

AM_MIDI2.0Libは1バイトずつ処理することでメモリ効率を最大化。
MIDI2Kitの `SysExAssembler` も同様のアプローチを採用。

### 4.2 定数定義の体系化

AM_MIDI2.0Libの `utils.h` には網羅的な定数定義がある。

```cpp
// MIDI-CIメッセージタイプ
#define MIDICI_DISCOVERY         0x70
#define MIDICI_DISCOVERYREPLY    0x71
// ...

// PEステータスコード
#define MIDICI_PE_STATUS_OK                   200
#define MIDICI_PE_STATUS_BAD_REQ              400
// ...
```

MIDI2Kitでも同様の定数は定義されているが、
より体系的な整理が参考になる。

### 4.3 UMPメッセージ生成関数

```cpp
namespace UMPMessage {
    inline uint32_t mt2NoteOn(uint8_t group, uint8_t channel,
                              uint8_t noteNumber, uint8_t velocity);
    inline std::array<uint32_t, 2> mt4NoteOn(uint8_t group, uint8_t channel,
                              uint8_t noteNumber, uint16_t velocity,
                              uint8_t attributeType, uint16_t attributeData);
    // ...
}
```

型安全なUMPメッセージ生成APIは参考になる。

### 4.4 Flex Data対応

AM_MIDI2.0Libは Flex Data (MT 0xD) を完全サポート:
- Tempo
- Time Signature
- Metronome
- Key Signature
- Chord
- Performance Text
- Lyric Text

MIDI2Kitでは現在 Flex Data 未対応。

---

## 5. MIDI2Kitに吸収可能な機能候補リスト

### 高優先度

| 機能 | 説明 | 実装難易度 | MIDI2Kitへの影響 |
|------|------|-----------|-----------------|
| **Flex Data対応** | MT 0xD メッセージの処理・生成 | 中 | MIDI2Core/UMP拡張 |
| **UMPメッセージ生成API** | 型安全なUMPメッセージビルダー | 低 | MIDI2Core/UMP拡張 |
| **PE Status Code定数** | 網羅的なステータスコード定義 | 低 | MIDI2PE拡張 |
| **Protocol Negotiation** | MIDI-CI 1.1のプロトコルネゴシエーション | 中 | MIDI2CI拡張 |

### 中優先度

| 機能 | 説明 | 実装難易度 | MIDI2Kitへの影響 |
|------|------|-----------|-----------------|
| **値スケーリング精緻化** | Expanded Bit Repeat Scheme | 低 | UMPTranslator改善 |
| **ランニングステータス最適化** | MIDI 1.0変換時の最適化 | 低 | UMPTranslator改善 |
| **Process Inquiry** | MIDI-CI PI機能 | 中 | 新規モジュール |

### 低優先度

| 機能 | 説明 | 実装難易度 | MIDI2Kitへの影響 |
|------|------|-----------|-----------------|
| **UMP Stream メッセージ** | MT 0xF 全メッセージ対応 | 中 | MIDI2Core/UMP拡張 |
| **MDS (Mixed Data Set)** | MT 5 の MDS 対応 | 高 | 新規機能 |
| **高解像度値表示** | 32bit値の人間可読表示 | 低 | ユーティリティ |

---

## 6. 比較分析: AM_MIDI2.0Lib vs MIDI2Kit

| 観点 | AM_MIDI2.0Lib | MIDI2Kit |
|------|--------------|----------|
| **言語** | C++ | Swift |
| **並行性** | シングルスレッド前提 | Actor-based (Swift Concurrency) |
| **メモリ管理** | 手動/RAII | ARC + 値型 |
| **エラー処理** | コールバック失敗 | 構造化エラー型 |
| **リトライ機構** | なし | 完全実装 |
| **タイムアウト管理** | なし | 設定可能 |
| **診断機能** | 基本的 | 充実 (trace, diagnostics) |
| **Request ID管理** | アプリケーション責任 | クールダウン付き自動管理 |
| **テスト** | 基本的 | 196+テスト |
| **ドキュメント** | Wiki形式 | DocC + CLAUDE.md |

### MIDI2Kitの優位点

1. **Swift Concurrency**: スレッドセーフな非同期処理
2. **リトライ機構**: 自動リトライと指数バックオフ
3. **タイムアウト管理**: 設定可能なタイムアウト
4. **診断機能**: 詳細なトレースと診断情報
5. **Request IDクールダウン**: 遅延応答の誤マッチ防止
6. **KORG互換性**: warm-up、Destination Cache

### AM_MIDI2.0Libの優位点

1. **省メモリ**: 組み込みデバイス対応
2. **シンプルさ**: header-onlyに近い構成
3. **Flex Data対応**: 完全なMT 0xD サポート
4. **Protocol Negotiation**: MIDI-CI 1.1機能
5. **Process Inquiry**: 完全実装

---

## 7. 結論と推奨事項

### 即座に採用可能な機能

1. **Flex Data対応の実装**
   - AM_MIDI2.0Libの `umpFlexData` 構造体とコールバックパターンを参考に
   - MIDI2Core/UMPモジュールに追加

2. **PE Status Code定数の拡充**
   - `utils.h` の定義を Swift enum に変換
   - MIDI2PE/PEError.swift に追加

3. **UMPメッセージビルダーAPI**
   - `UMPMessage::*` の型安全な設計を参考に
   - MIDI2Core/UMP/UMPMessage.swift に追加

### 将来的な検討事項

1. **Process Inquiry対応**
   - 新規モジュール `MIDI2PI` として実装
   - AM_MIDI2.0Libの設計を参考に

2. **MDS (Mixed Data Set) 対応**
   - MT 5 の高度な機能
   - 需要を見て実装検討

### 参考にしない点

1. **シングルスレッド前提の設計**: MIDI2KitはActor-basedを維持
2. **エラーハンドリングの簡素さ**: 構造化エラー型を維持
3. **手動メモリ管理**: Swift ARC + 値型を維持

---

## 8. 参考リンク

- [AM_MIDI2.0Lib GitHub](https://github.com/midi2-dev/AM_MIDI2.0Lib)
- [MIDI 2.0 Specification](https://midi.org/specifications)
- [MIDI-CI Specification](https://midi.org/midi-ci)
- [Property Exchange Specification](https://midi.org/property-exchange)
