# v1.0.9 Migration Guide

Migration guide for MIDI2Kit v1.0.9. This guide covers new features added in v1.0.6 through v1.0.9.

---

## Table of Contents

- [What's New in v1.0.9](#whats-new-in-v109)
- [What's New in v1.0.8](#whats-new-in-v108)
- [What's New in v1.0.7](#whats-new-in-v107)
- [What's New in v1.0.6](#whats-new-in-v106)
- [Using New Features](#using-new-features)
  - [KORG ChannelList/ProgramList Auto-Conversion (v1.0.9)](#korg-channellistprogramlist-auto-conversion-v109)
  - [KORG Optimization Features (v1.0.8)](#korg-optimization-features-v108)
  - [Adaptive WarmUp Strategy (v1.0.8)](#adaptive-warmup-strategy-v108)
  - [Vendor Optimization Settings (v1.0.8)](#vendor-optimization-settings-v108)
- [Migration Checklist](#migration-checklist)

---

## What's New in v1.0.9

### New Features

1. **KORG ChannelList/ProgramList Auto-Conversion**
   - Auto-converts KORG format (`bankPC: [Int]` array) to standard format
   - `PEProgramDef`: `title` → `name`, `bankPC: [bankMSB, bankLSB, program]` → individual properties
   - `PEChannelInfo`: `bankPC: [Int]` → `bankMSB`, `bankLSB`, `programNumber`
   - Maintains backward compatibility with standard format

2. **New APIs**
   - `getChannelList(from:timeout:)`: Auto-detects vendor and selects `X-ChannelList`/`ChannelList`
   - `getProgramList(from:timeout:)`: Auto-detects vendor and fetches ProgramList

### Impact

- **No Breaking Changes**: Existing code works without modification
- **Benefits**: Seamless integration when using ChannelList/ProgramList with KORG devices

---

## What's New in v1.0.8

### New Features

1. **KORG Optimization Features**
   - Skip ResourceList and directly fetch X-ParameterList (99% faster, 16.4s → 144ms)
   - `getOptimizedResources()` - Auto-select optimized path
   - `getXParameterList()` - Get X-ParameterList
   - `getXProgramEdit()` - Get X-ProgramEdit

2. **Adaptive WarmUp Strategy**
   - Learn success/failure per device and auto-select optimal warmup strategy
   - `.adaptive` strategy is default (recommended)

3. **Vendor Optimization Settings**
   - `VendorOptimizationConfig` - Customize vendor-specific optimizations

### Impact

- **No Breaking Changes**: Existing code works without modification
- **Deprecated**: `warmUpBeforeResourceList: Bool` → `warmUpStrategy: WarmUpStrategy` (backward compatibility maintained)

---

## What's New in v1.0.7

### Bug Fixes

- **AsyncStream race condition fixed**: Fixed similar bugs in 4 files
  - `CoreMIDITransport.swift`: Production MIDI I/O (highest priority)
  - `MockMIDITransport.swift`: Test infrastructure
  - `LoopbackTransport.swift`: Test infrastructure
  - `PESubscriptionManager.swift`: Subscription events
  - All AsyncStreams unified to `makeStream()` pattern

### Impact

- **No Impact**: Internal fixes, no API changes

---

## What's New in v1.0.6

### Critical Bug Fix

- **CIManager.events AsyncStream race condition fixed**
  - `CIManager.events` stream was not firing events
  - In v1.0.5 and earlier, `.deviceDiscovered`, `.deviceLost` events were not firing

### Impact

- **Affected**: All code using CIManager directly
- **Resolution**: Update to v1.0.6 for events to fire correctly
- **Recommended**: No issues if using MIDI2Client

---

## Using New Features

### KORG ChannelList/ProgramList Auto-Conversion (v1.0.9)

Starting in v1.0.9, KORG format (`bankPC: [Int]` array) is automatically converted to standard format.

#### Get ChannelList

```swift
// v1.0.9+: Auto-detect vendor and select appropriate resource
let channels = try await client.getChannelList(from: device.muid)
for ch in channels {
    print("Ch \(ch.channel): \(ch.programTitle ?? "No Program")")

    // KORG format auto-converted, access with standard properties
    if let bankMSB = ch.bankMSB,
       let bankLSB = ch.bankLSB,
       let program = ch.programNumber {
        print("  Bank: \(bankMSB)-\(bankLSB), Program: \(program)")
    }
}
```

#### Get ProgramList

```swift
// v1.0.9+: KORG format auto-conversion
let programs = try await client.getProgramList(from: device.muid)
for prog in programs {
    // name property (auto-mapped from KORG's title)
    print("\(prog.displayName)")

    // bankPC array auto-expanded to individual properties
    print("  Bank: \(prog.bankMSB)-\(prog.bankLSB)")
    print("  Program: \(prog.programNumber)")
}
```

#### Comparison with Old API (v1.0.8 and earlier)

```swift
// v1.0.8 and earlier: Manually specify X-ChannelList
let response = try await client.get("X-ChannelList", from: device.muid)
let channels = try JSONDecoder().decode([PEChannelInfo].self, from: response.decodedBody)

// v1.0.9+: Auto-detect vendor and select
let channels = try await client.getChannelList(from: device.muid)
```

#### KORG Format Details

**ProgramList - KORG Format**

```json
{
  "title": "Grand Piano",
  "bankPC": [0, 0, 10]
}
```

**Auto-Converted**

```json
{
  "name": "Grand Piano",
  "bankPC": 0,
  "bankCC": 0,
  "program": 10
}
```

**ChannelList - KORG Format**

```json
{
  "channel": 0,
  "title": "Piano",
  "programTitle": "Grand Piano",
  "bankPC": [0, 0, 10]
}
```

**Auto-Converted**

```json
{
  "channel": 0,
  "title": "Piano",
  "programTitle": "Grand Piano",
  "bankPC": 0,
  "bankCC": 0,
  "program": 10
}
```

---

### KORG Optimization Features (v1.0.8)

Starting in v1.0.8, skip ResourceList and directly fetch X-ParameterList for KORG devices. Achieves 99% speedup (16.4s → 144ms).

#### Using getOptimizedResources()

```swift
// Auto-select optimized path
let result = try await client.getOptimizedResources(from: device.muid)

if result.usedOptimizedPath {
    // KORG optimized path used
    if let params = result.xParameterList {
        print("✅ KORG optimized path used (\(params.count) parameters)")
        for param in params {
            print("CC\(param.controlCC): \(param.displayName)")
        }
    }
} else {
    // Standard path used
    if let resources = result.standardResourceList {
        print("ℹ️ Standard path used (\(resources.count) resources)")
        for resource in resources {
            print("Resource: \(resource.resource)")
        }
    }
}
```

#### Using getXParameterList()

```swift
// KORG X-ParameterList (CC number → parameter name mapping)
let params = try await client.getXParameterList(from: device.muid)

// Display parameter list
for param in params {
    print("\(param.displayName) (CC\(param.controlCC))")
    print("  Range: \(param.effectiveMinValue)...\(param.effectiveMaxValue)")
    if let defaultValue = param.defaultValue {
        print("  Default: \(defaultValue)")
    }
}

// Convenient extension methods
let byCC = params.byControlCC
if let volumeParam = byCC[7] {
    print("Volume: \(volumeParam.displayName)")
}
```

#### Using getXProgramEdit()

```swift
// KORG X-ProgramEdit (current program data)
let program = try await client.getXProgramEdit(from: device.muid)

print("Program: \(program.displayName)")
if let category = program.category {
    print("Category: \(category)")
}

// Get parameter value
if let instLevel = program.value(for: 11) {
    print("Inst Level (CC11): \(instLevel)")
}

// Display all parameters
for (cc, value) in program.parameterValues {
    print("CC\(cc) = \(value)")
}
```

#### Performance Comparison

| Operation | v1.0.7 and earlier | v1.0.8+ (KORG optimization) | Improvement |
|-----------|-------------------|----------------------------|-------------|
| ResourceList | 16.4s | Skipped | N/A |
| X-ParameterList | N/A | 144ms | **99.1% faster** |

---

### Adaptive WarmUp Strategy (v1.0.8)

Starting in v1.0.8, learn success/failure per device and auto-select optimal warmup strategy.

#### Default Settings (Adaptive)

```swift
// v1.0.8+ uses Adaptive strategy by default
var config = MIDI2ClientConfiguration()
// config.warmUpStrategy = .adaptive  // Default, no need to set

let client = try MIDI2Client(name: "MyApp", configuration: config)
```

#### Changing Strategy

```swift
var config = MIDI2ClientConfiguration()

// Always warm-up (max reliability)
config.warmUpStrategy = .always

// Never warm-up (fastest)
config.warmUpStrategy = .never

// Vendor-based optimization (KORG: X-ParameterList as warmup)
config.warmUpStrategy = .vendorBased
```

#### WarmUpCache Diagnostics

```swift
// Get cache diagnostic info
if let cache = await client.warmUpCache {
    let diag = await cache.diagnostics
    print(diag.description)
    // Example output: "WarmUpCache: 2 need warm-up, 5 don't, 7 total"
}
```

#### How Adaptive Works

1. **First Request**: Try without warm-up
2. **On Failure**: Retry with warm-up, record device as "needs warm-up"
3. **Subsequent Requests**: Decide warm-up based on recorded result

---

### Vendor Optimization Settings (v1.0.8)

Starting in v1.0.8, customize vendor-specific optimizations.

#### Default Settings (KORG optimization enabled)

```swift
var config = MIDI2ClientConfiguration()
// config.vendorOptimizations = .default  // Default, no need to set

// Default enables KORG optimizations:
// - skipResourceListWhenPossible
// - useXParameterListAsWarmup
// - preferVendorResources
```

#### Disable All Optimizations

```swift
var config = MIDI2ClientConfiguration()
config.vendorOptimizations = .none

let client = try MIDI2Client(name: "MyApp", configuration: config)
```

#### Custom Optimization

```swift
var config = MIDI2ClientConfiguration()

// Enable KORG optimizations individually
config.vendorOptimizations.enable(.skipResourceListWhenPossible, for: .korg)
config.vendorOptimizations.enable(.useXParameterListAsWarmup, for: .korg)

// Disable specific optimization
config.vendorOptimizations.disable(.preferVendorResources, for: .korg)

// Check status
if config.vendorOptimizations.isEnabled(.skipResourceListWhenPossible, for: .korg) {
    print("KORG optimization enabled")
}
```

#### Available Optimization Options

| Option | Description | Target Vendor |
|--------|-------------|---------------|
| `skipResourceListWhenPossible` | Skip ResourceList (99% faster) | KORG |
| `useXParameterListAsWarmup` | Use X-ParameterList as warmup | KORG |
| `preferVendorResources` | Prefer vendor-specific resources | KORG |
| `extendedMultiChunkTimeout` | Extended timeout for multi-chunk | All vendors |

---

## Migration Checklist

### Migrating to v1.0.6

- [ ] If using CIManager directly, update to v1.0.6
- [ ] Verify `.deviceDiscovered`, `.deviceLost` events fire correctly

### Migrating to v1.0.7

- [ ] None (internal fixes only)

### Migrating to v1.0.8

- [ ] If using `warmUpBeforeResourceList`, migrate to `warmUpStrategy` (optional)
- [ ] If using KORG devices, try KORG optimization features
- [ ] Try `getOptimizedResources()`, `getXParameterList()`, `getXProgramEdit()`
- [ ] Verify Adaptive WarmUp Strategy effectiveness

### Migrating to v1.0.9

- [ ] If using ChannelList/ProgramList with KORG devices, migrate to new APIs
- [ ] Use `getChannelList()` to fetch ChannelList (vendor auto-detection)
- [ ] Use `getProgramList()` to fetch ProgramList (KORG format auto-conversion)
- [ ] Access program name with `PEProgramDef.name` property
- [ ] Access Bank/Program info with `PEChannelInfo.bankMSB`, `bankLSB`, `programNumber`

---

## Recommended Settings

### For KORG Devices (v1.0.9 Recommended)

```swift
var config = MIDI2ClientConfiguration()

// Adaptive WarmUp (default)
config.warmUpStrategy = .adaptive

// KORG optimization enabled (default)
config.vendorOptimizations = .default

// PE Timeout: Slightly longer
config.peTimeout = .seconds(7)

// Multi-chunk timeout multiplier: Slightly higher
config.multiChunkTimeoutMultiplier = 2.0

let client = try MIDI2Client(name: "MyApp", configuration: config)

// Use KORG optimization APIs
let result = try await client.getOptimizedResources(from: device.muid)
let channels = try await client.getChannelList(from: device.muid)
let programs = try await client.getProgramList(from: device.muid)
```

### For Standard MIDI 2.0 Devices

```swift
// Default settings are sufficient
let client = try MIDI2Client(name: "MyApp")
```

---

## Troubleshooting

### CIManager.events not firing events (v1.0.5 and earlier)

**Symptom**: `.deviceDiscovered`, `.deviceLost` events not firing

**Solution**: Update to v1.0.6 or later

### KORG ResourceList timeouts (v1.0.7 and earlier)

**Symptom**: ResourceList timeouts with KORG devices

**Solution**: Update to v1.0.8+ and use `getOptimizedResources()`

```swift
// v1.0.8+
let result = try await client.getOptimizedResources(from: device.muid)
```

### warmUpBeforeResourceList deprecated

**Symptom**: Deprecation warning when using `warmUpBeforeResourceList`

**Solution**: Migrate to `warmUpStrategy`

```swift
// v1.0.7 and earlier
config.warmUpBeforeResourceList = true

// v1.0.8+ (recommended)
config.warmUpStrategy = .adaptive  // or .always, .never, .vendorBased
```

---

## Related Resources

- [API Reference](API-Reference.md) - API reference
- [KORG Optimization Guide](KORG-Optimization.md) - Detailed guide for KORG optimization features
- [CHANGELOG](../CHANGELOG.md) - Change history
- [README](../README.md) - Project overview
