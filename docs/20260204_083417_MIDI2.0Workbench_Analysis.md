# MIDI 2.0 Workbench 調査レポート

調査日: 2026-02-04
調査対象: https://github.com/midi2-dev/MIDI2.0Workbench

---

## 1. プロジェクト概要

### 基本情報
- **名前**: MIDI 2.0 Workbench
- **説明**: MIDI 2.0 Testing Tool
- **ライセンス**: MIT License
- **著作権**: Yamaha Corporation 2020
- **主要開発者**: Andrew Mee
- **スター数**: 83 / Fork数: 13
- **作成日**: 2023-11-17
- **最終更新**: 2026-01-27

### 技術スタック

| カテゴリ | 技術 |
|---------|------|
| ランタイム | Electron 19.1.9 + Node.js 16.x |
| メイン言語 | JavaScript (1,684,712 bytes) |
| ネイティブ | C++ (112,432 bytes) - USB MIDI 2.0用 |
| UI | HTML/CSS/Less/SCSS + jQuery + Bootstrap |
| MIDIアクセス | node-midi, serialport, usb_midi_2 (カスタム) |
| データ検証 | AJV (JSON Schema validator) |
| 圧縮 | pako (zlib) |
| その他 | bonjour-service, Tone.js (オーディオ) |

### アーキテクチャ

```
MIDI2.0Workbench/
├── main.js              # Electronメインプロセス (45KB)
├── libs/                # コアライブラリ
│   ├── midici.js        # MIDI-CI実装 (79KB) ⭐主要
│   ├── ciParts.js       # MIDI-CI構成要素 (35KB)
│   ├── translations.js  # UMP変換 (58KB)
│   ├── streams.js       # PEチャンク管理
│   ├── profiles.js      # Profile定義 (31KB)
│   ├── midiCITables.js  # メッセージタイプテーブル
│   ├── interoperability.js # 相互運用性テスト
│   └── UMPMIDI1.js      # MIDI 1.0統合
├── midi2usb/            # USB MIDI 2.0 (C++アドオン)
├── output/              # レンダラープロセス + UI
│   ├── app/             # アプリケーションJS
│   └── help/            # ヘルプドキュメント
└── libs/schema/         # JSON Schema定義
```

---

## 2. 実装されている機能一覧

### MIDI-CI v1.1/1.2 完全実装

| 機能カテゴリ | 実装済み機能 |
|-------------|-------------|
| **Discovery** | Discovery Request/Reply, Endpoint Information |
| **Property Exchange** | GET/SET/Subscribe/Notify, チャンク処理 |
| **Profile Configuration** | Profile Inquiry, Enable/Disable, Details |
| **Process Inquiry** | Capabilities, MIDI Message Report |
| **Protocol Negotiation** | v1.1のみ (v1.2で非推奨) |

### UMPメッセージ処理

- **Message Type 0-5**: Utility, System, MIDI 1.0 CV, Data 64, MIDI 2.0 CV, Data 128
- **Message Type F**: UMP Endpoint Discovery/Reply
- **Flex Data**: テキスト、メタデータ処理
- **SysEx 7/8**: フル対応

### トランスポート

1. **USB MIDI 2.0** (macOS 14+, Linux 6.5+)
   - ネイティブC++アドオン
   - Group Block検出

2. **MIDI 1.0 ブリッジ**
   - node-midiによる従来MIDIデバイス接続
   - UMP⇔MIDI1変換

3. **シリアルポート**
   - serialportライブラリ使用
   - COBSエンコーディング対応

4. **ネットワーク (Bonjour/mDNS)**
   - 実験的サポート

### テスト・検証機能

1. **SMF 2.0 (Standard MIDI File 2.0)**
   - CLIPファイル解析・検証
   - UMPストリーム表示

2. **相互運用性チェックリスト**
   - MIDI-CI準拠テスト (自動+手動)
   - MIDI 2.0ロゴ認証対応

3. **デバッグツール**
   - SysEx詳細ブレークダウン
   - UMPメッセージ可視化
   - PE要求/応答トレース

---

## 3. MIDI-CI / Property Exchange / UMP関連の実装詳細

### 3.1 MIDI-CI実装 (libs/midici.js)

```javascript
// クラス構造
class midici {
    constructor(opts) {
        this.remoteDevices = {};      // 発見したデバイス
        this.remoteDevicesInternal = {}; // 内部状態
        this.cbResponses = {};        // コールバック管理
        this.ciVer = 0x02;            // MIDI-CI 1.2
    }

    // 主要メソッド
    sendDiscovery(umpDev, group, ciSupport)
    processCI(msgObj, group, umpDev)
    peCapabilityStart(remoteMuid, cb)
    getResourceList(remoteMuid)
    // ...
}
```

#### MIDI-CIバージョン処理
- v1.1とv1.2の両方をサポート
- メッセージフォーマットバージョン別のヘッダー処理
- 非推奨メッセージの警告表示

#### メッセージタイプ定義 (midiCITables.js)
```javascript
exports.ciTypes = {
    0x70: { title: 'Discovery Request', header: [...], reply: 0x71 },
    0x71: { title: 'Discovery Reply', ... },
    0x34: { title: 'Inquiry: Get Property Data', streams: 'request' },
    0x35: { title: 'Reply to Get Property Data', streams: 'reply' },
    // ... 全MIDI-CIメッセージタイプ
}
```

### 3.2 Property Exchange実装

#### ストリーム管理 (libs/streams.js)
```javascript
exports.streamOut = function(numberOfStreams, timeOut, sysexTimer) {
    // 同時リクエスト数制限 (0-127)
    // タイムアウト管理
    // チャンク送信キュー
    // リトライ機能 (最大3回)
}

exports.streamIn = function() {
    // 受信チャンク組み立て
    // ヘッダー/ボディ分離
}
```

#### PE処理フロー
1. `peCapabilityStart()`: PE機能確認
2. `getResourceList()`: リソース一覧取得
3. `peGetRequest()`: プロパティ取得
4. `peSetRequest()`: プロパティ設定
5. `peSubscription()`: サブスクリプション管理

#### エンコーディング対応
- **ASCII**: そのまま
- **Mcoded7**: 8→7bit変換
- **zlib+Mcoded7**: pako使用でzlib圧縮後Mcoded7

### 3.3 UMP処理 (libs/translations.js)

#### MIDI 1.0 → UMP変換
```javascript
t.midi10ToUMP = function(group, msg) {
    // MIDI 1.0バイト列をUMPに変換
    // ランニングステータス対応
    // SysEx分割処理
}
```

#### UMP → MIDI 1.0変換
```javascript
t.umpToMidi10 = function(ump) {
    // UMPをMIDI 1.0バイト列に変換
    // Note On velocity 0 → Note Off変換
    // 値スケーリング (32bit→7bit)
}
```

#### UMP 1.0 → UMP 2.0変換
```javascript
t.ump10To20 = function(ump10, deviceid) {
    // RPN/NRPN処理 (CC 6,38,98-101)
    // Bank Select + Program Change統合
    // 値スケーリング (7bit→32bit)
}
```

### 3.4 JSON Schema検証

`libs/schema/` に公式MIDI仕様のJSONスキーマを収録:
- M2-103-S_v1-0_ResourceList.json
- M2-105-S_v1-0_DeviceInfo.json
- M2-105-S_v1-0_ChannelList.json
- M2-112-S_v1-0_StateList.json
- M2-117-S_v1-0_AllCtrlList.json
- etc.

AJVライブラリでPE応答を自動検証。

---

## 4. MIDI2Kit（Swift MIDI 2.0ライブラリ）に参考になる点

### 4.1 優れた設計パターン

| パターン | Workbench実装 | MIDI2Kitへの適用 |
|---------|--------------|-----------------|
| **メッセージタイプテーブル** | ciTypesオブジェクトで全メッセージを宣言的に定義 | CIMessageTypeテーブルで保守性向上 |
| **パーツベース組み立て** | ciPartsで各フィールドを独立定義、組み合わせで処理 | CIMessagePartプロトコルで拡張性向上 |
| **ストリーム抽象化** | streamIn/streamOutで入出力を統一 | PEStreamProtocolで抽象化可能 |
| **スキーマ検証** | AJVで応答を自動検証 | 同様の検証機能追加 |

### 4.2 相互運用性テスト知見

Workbenchの`interoperability.js`には詳細なテストケースが定義:
```javascript
// 例: Discovery後のMUID衝突テスト
{
    id: "ci4.2",
    text: "Invalidate MUID受信後、新MUIDで再Discovery",
    test: function(opts) { ... }
}
```

**MIDI2Kitへの示唆**:
- 相互運用性テストスイートの追加
- MUID衝突ハンドリングの強化
- 自動テスト可能なデバイスシミュレーター

### 4.3 エンコーディング処理

Workbenchのzlib+Mcoded7実装:
```javascript
// pako (zlib) + Mcoded7
const pako = require('pako');
const deflated = pako.deflate(data);
const mcoded = encodeMcoded7(deflated);
```

**MIDI2Kitの状況**: 既にZlibMcoded7.swift実装済み

### 4.4 USB MIDI 2.0対応

Workbenchはネイティブ(C++)でUSB MIDI 2.0デバイスに直接アクセス:
- Group Block検出
- Endpoint Discovery

**MIDI2Kitへの示唆**: CoreMIDIのUSB MIDI 2.0サポートに依存するため直接適用は困難だが、Group Block概念の理解に有用。

---

## 5. MIDI2Kitに吸収可能な機能の候補リスト

### 優先度: 高

| 機能 | 難易度 | 説明 |
|-----|--------|-----|
| **JSON Schema検証** | 中 | PE応答をJSON Schemaで自動検証 |
| **SMF 2.0パーサー** | 高 | CLIPファイルの読み書き |
| **Profile定義データベース** | 低 | 標準プロファイル定義の移植 |
| **相互運用性テスト** | 中 | 仕様準拠検証テストスイート |

### 優先度: 中

| 機能 | 難易度 | 説明 |
|-----|--------|-----|
| **Manufacturer IDデータベース** | 低 | 30KB相当の製造者ID一覧 |
| **詳細デバッグUI仕様** | - | SysExブレークダウン表示方法の参考 |
| **Process Inquiry実装** | 高 | MIDI Message Report機能 |
| **Protocol Negotiation** | 中 | v1.1互換（v1.2では非推奨） |

### 優先度: 低（将来検討）

| 機能 | 難易度 | 説明 |
|-----|--------|-----|
| **ネットワークMIDI** | 高 | Bonjour/mDNS経由のMIDI |
| **MIDI 1.0ブリッジ** | 中 | 従来MIDI機器とのUMP変換ブリッジ |
| **オーディオ合成** | 高 | Tone.js相当の機能（スコープ外） |

### 既にMIDI2Kitで実装済み

以下はWorkbenchにもあるがMIDI2Kitで既に実装済み:
- UMP⇔MIDI1変換 (UMPTranslator.swift)
- zlib+Mcoded7 (ZlibMcoded7.swift)
- リトライ機能 (withPERetry)
- チャンク処理 (PEChunkAssembler)
- タイムアウト管理

---

## 6. 追加調査メモ

### Workbenchの制限事項（README記載）
> This project uses a lot of raw data, as such it may not use available OS API's.
> It is recommended to use OS API's where available, and this project should not
> be seen as reference code.

つまり、Workbenchはテスト・デバッグ目的であり、プロダクション向けの参考実装ではない。

### MIDI2Kitとの主な違い

| 観点 | MIDI 2.0 Workbench | MIDI2Kit |
|-----|-------------------|----------|
| 目的 | テスト・デバッグツール | プロダクションライブラリ |
| 言語 | JavaScript (Electron) | Swift 6 |
| 並行性 | シングルスレッド + callback | Actor-based concurrency |
| トランスポート | 直接USB/MIDI/Serial | CoreMIDI抽象化 |
| エラー処理 | console.log中心 | 構造化エラー型 |
| テスト | なし | 196+テスト |
| 型安全性 | なし (JavaScript) | 完全型付け (Swift) |

---

## 結論

MIDI 2.0 Workbenchは、MIDI 2.0仕様の実装を理解するための優れたリファレンスである。特に:

1. **MIDI-CIメッセージタイプテーブル**: 宣言的定義パターンが参考になる
2. **JSON Schema**: PE応答検証に活用可能
3. **相互運用性テスト**: テストスイート設計の参考
4. **Profile定義**: 標準プロファイルデータの移植候補

ただし、コード品質・アーキテクチャ面ではMIDI2Kitが優れており、直接のコード移植よりも「設計知見の抽出」が有効である。
