# MIDI2Kit 日報 - 2026-01-13

## 作業時間
- 開始: 13:30
- 終了: 15:50
- 合計: 2時間20分

## 今日の進捗

### [バグ修正] Property Exchange メッセージフォーマット修正

#### 1. PE Get Inquiry フォーマット修正 (14:00-14:30)

**問題**: PE Get Inquiryリクエストに対してデバイスが404エラーを返す

**原因**: MIDI-CI 1.2仕様 (M2-105-UM Section 6.4.1) によると、PE Get Inquiryには`numChunks`/`thisChunk`フィールドは含まれない（Replyのみ）

**修正ファイル**: `Sources/MIDI2CI/CIMessageBuilder.swift`

```swift
// 修正前（誤）
public static func peGetInquiry(...) -> [UInt8] {
    // ...
    result.append(0x01)  // numChunks LSB (不要)
    result.append(0x00)  // numChunks MSB (不要)
    result.append(0x01)  // thisChunk LSB (不要)
    result.append(0x00)  // thisChunk MSB (不要)
    // ...
}

// 修正後（正）
public static func peGetInquiry(...) -> [UInt8] {
    // numChunks/thisChunk削除
    // requestID + headerSize + headerData のみ
}
```

同様に `peSubscribeInquiry` も修正。

---

#### 2. PE Get Reply パーサー修正 (14:30-15:00)

**問題**: PE Get Replyのパースに失敗

**原因**: MIDI-CI 1.2仕様では headerData は headerSize の**直後**に配置されるが、実装では numChunks/thisChunk/dataSize の後に配置されると誤解していた

**MIDI-CI 1.2仕様 (M2-105-UM Section 6.4.2) 正しいフォーマット**:
```
[requestID: 1B] [headerSize: 2B] [headerData: N bytes] [numChunks: 2B] [thisChunk: 2B] [dataSize: 2B] [propertyData: M bytes]
```

**修正ファイル**: `Sources/MIDI2CI/CIMessageParser.swift`

```swift
// 修正前（誤）
let headerData = Data(bytes[(idx + 9)..<(idx + 9 + headerSize)])

// 修正後（正）
let headerData = Data(bytes[(idx + 3)..<(idx + 3 + headerSize)])
// その後 numChunks/thisChunk/dataSize を読む
```

---

#### 3. PEDeviceInfo KORG対応 (15:00-15:50)

**問題**: DeviceInfo JSONは正常に取得できるが、パース結果が「Unknown Device」

**原因**: KORGデバイスが返すJSONキーが標準MIDI-CI形式と異なる

| MIDI-CI標準 | KORG形式 |
|-------------|----------|
| `manufacturerName` | `manufacturer` |
| `productName` | `model` |
| `familyName` | `family` |
| `softwareVersion` | `version` |

**修正ファイル**: `Sources/MIDI2PE/PETypes.swift`

```swift
enum CodingKeys: String, CodingKey {
    case manufacturerName
    case productName
    // ... 標準キー
    
    // KORG alternative keys
    case manufacturer
    case model
    case family
    case version
}

public init(from decoder: Decoder) throws {
    // Try standard format first, fall back to KORG format
    manufacturerName = try container.decodeIfPresent(String.self, forKey: .manufacturerName)
        ?? container.decodeIfPresent(String.self, forKey: .manufacturer)
    // ...
}
```

## 修正ファイル一覧

| ファイル | 修正内容 |
|----------|----------|
| `Sources/MIDI2CI/CIMessageBuilder.swift` | PE Inquiry からnumChunks/thisChunk削除 |
| `Sources/MIDI2CI/CIMessageParser.swift` | PE Reply headerData位置修正 |
| `Sources/MIDI2PE/PETypes.swift` | PEDeviceInfo KORG JSONキー対応 |

## テスト結果

### KORG Module Pro との通信テスト ✅

```
ResourceList取得: ✅ 成功
DeviceInfo取得: ✅ 成功 → "Module Pro" 表示
X-ParameterList取得: ✅ 成功 → CC名マッピング動作
```

### DeviceInfo パース結果
```json
{
  "manufacturerId": [66,0,0],
  "manufacturer": "KORG Inc.",
  "familyId": [118,1],
  "family": "KORG Module",
  "modelId": [4,0],
  "model": "Module Pro",
  "versionId": [9,0,5,0],
  "version": "5.0.10"
}
```
→ `displayName: "Module Pro"` ✅

## 課題・TODO

- [x] PE Get Inquiry フォーマット修正
- [x] PE Get Reply パーサー修正
- [x] PEDeviceInfo KORG対応
- [x] SimpleMIDIController統合テスト
- [ ] ユニットテスト追加（PE Inquiry/Reply フォーマット）
- [ ] README更新（KORG互換性について）

## 技術メモ

### MIDI-CI 1.2 PE メッセージ構造

**PE Get Inquiry (0x34)**:
```
[Universal SysEx Header]
[sourceMUID: 4B]
[destinationMUID: 4B]
[requestID: 1B]
[headerSize: 2B (14-bit)]
[headerData: variable]
```
※ numChunks/thisChunk/dataSize は含まない

**PE Get Reply (0x35)**:
```
[Universal SysEx Header]
[sourceMUID: 4B]
[destinationMUID: 4B]
[requestID: 1B]
[headerSize: 2B (14-bit)]
[headerData: variable]      ← headerSizeの直後！
[numChunks: 2B (14-bit)]
[thisChunk: 2B (14-bit)]
[dataSize: 2B (14-bit)]
[propertyData: variable]
```

### 参考資料
- MIDI-CI 1.2 Specification (M2-105-UM)
- KORG Module Pro MIDI Implementation
