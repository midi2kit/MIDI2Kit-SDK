# 日報 2026-01-10

## 時間管理

**作業時間:** 15:22 - 00:30 (約9時間)

| 時間 | 作業内容 | 所要時間 |
|------|---------|---------|
| 15:22-16:30 | MIDI2Kit設計・Package.swift作成 | 1h 10m |
| 16:30-18:00 | MIDI2Core実装 (MUID, DeviceIdentity, Mcoded7, Constants) | 1h 30m |
| 18:00-19:00 | MIDI2CI実装 (DiscoveredDevice, MessageBuilder, Parser) | 1h |
| 19:00-20:30 | MIDI2PE実装 (PEResource, PETypes, ChunkAssembler, RequestIDManager) | 1h 30m |
| 20:30-21:30 | MIDI2Transport実装 (MIDITransport, CoreMIDI, Mock, SysExAssembler) | 1h |
| 21:30-22:30 | テスト作成・デバッグ (48テスト) | 1h |
| 22:30-23:30 | PETransactionManager追加・リーク防止対策 | 1h |
| 23:30-00:00 | CoreMIDITransport改善 (二重接続防止、パフォーマンス) | 30m |
| 00:00-00:30 | ドキュメント作成 (README, Architecture, API, BestPractices) | 30m |

**合計:** 約9時間

### 時間配分

```
実装      ████████████████████  67% (6h)
テスト    ████                  11% (1h)
設計      ████                  11% (1h)
ドキュメント ███                 11% (1h)
```

## 概要

MIDI2Kit ライブラリの新規作成と、Request IDリーク・二重接続問題の対策を実装。

## 作業内容

### 1. MIDI2Kit ライブラリ新規作成

デスクトップに新規Swift Packageとして作成。

**プロジェクト構成:**
```
MIDI2Kit/
├── Package.swift (Swift 6.0, iOS 17+/macOS 14+)
├── README.md
├── LICENSE (MIT)
├── .gitignore
├── Documentation/
│   ├── Architecture.md
│   ├── API.md
│   └── BestPractices.md
├── Sources/
│   ├── MIDI2Core/
│   ├── MIDI2CI/
│   ├── MIDI2PE/
│   ├── MIDI2Transport/
│   └── MIDI2Kit/
└── Tests/MIDI2KitTests/
```

### 2. MIDI2Core モジュール

| ファイル | 内容 |
|---------|------|
| MUID.swift | 28-bit識別子、broadcast/reserved、ランダム生成、4バイトシリアライズ |
| DeviceIdentity.swift | ManufacturerID（標準/拡張）、family/model/version、11バイトシリアライズ |
| MIDICIConstants.swift | SysExフレーミング、CIバージョン、CategorySupport、CIMessageType（40+種類） |
| Mcoded7.swift | 8-bit→7-bitエンコード（7バイト→8バイト、高ビットプレフィックス） |

### 3. MIDI2CI モジュール

| ファイル | 内容 |
|---------|------|
| DiscoveredDevice.swift | MUID、identity、categorySupport、maxSysExSize、outputPath |
| CIMessageBuilder.swift | Discovery inquiry/reply、PE capability/get/set inquiry、JSONヘッダービルダー |
| CIMessageParser.swift | CIメッセージパース、Discovery/PE/NAKペイロード抽出 |

### 4. MIDI2PE モジュール

| ファイル | 内容 |
|---------|------|
| PEResource.swift | 標準リソース（ResourceList, DeviceInfo, ChCtrlList等）、ベンダー拡張 |
| PETypes.swift | PEHeader、PEStatus（HTTPスタイルコード）、PEDeviceInfo、PEControllerDef |
| PEChunkAssembler.swift | マルチチャンク組立、タイムアウト（デフォルト3秒）、ヘッダー保持 |
| PERequestIDManager.swift | 7-bit ID管理（0-127）、衝突回避、ラップアラウンド |
| **PETransactionManager.swift** | **トランザクションライフサイクル管理（リーク防止の要）** |

### 5. MIDI2Transport モジュール

| ファイル | 内容 |
|---------|------|
| MIDITransport.swift | プロトコル定義（send, received stream, sources/destinations） |
| CoreMIDITransport.swift | CoreMIDI実装、接続状態管理、SysEx組立 |
| MockMIDITransport.swift | テスト用モック、メッセージ注入・記録 |
| SysExAssembler.swift | フラグメント組立、破損検出 |

### 6. 重要な問題対策

#### 6.1 Request ID リーク防止

**問題:** Request IDは7-bit（0-127）に限定。解放漏れが蓄積すると枯渇してPEが崩壊。

**典型的なリーク経路:**
- PE Reply が `status >= 400` で return してトランザクションを消さない
- チャンク欠落・タイムアウトで処理不能になりトランザクションを消さない

**対策: PETransactionManager**

```swift
public actor PETransactionManager {
    // ライフサイクル
    func begin(resource:, destinationMUID:, timeout:) -> UInt8?
    func complete(requestID:, header:, body:)
    func completeWithError(requestID:, status:, message:)
    func cancel(requestID:)
    func cancelAll(for muid:)  // デバイス切断時
    
    // タイムアウト
    func checkTimeouts() -> [UInt8]  // 定期呼び出し
    
    // 待機
    func waitForCompletion(requestID:) async -> PETransactionResult
}
```

#### 6.2 MIDI Source 二重接続防止

**問題:** `msgSetupChanged`で「全ソースへconnect」を繰り返すと、同一ソースへ重複接続して受信が二重化。

**対策: ConnectionState + 差分接続**

```swift
private final class ConnectionState {
    private let lock = NSLock()
    private var connectedSources: Set<MIDIEndpointRef>
    // 同期アクセス可能（deinitでも使用可能）
}

// 差分接続
func connectToAllSources() async throws {
    let current = getCurrentSources()
    let connected = connectionState.getConnected()
    
    // 削除されたものを切断
    for source in connected.subtracting(current) {
        MIDIPortDisconnectSource(inputPort, source)
    }
    
    // 新規のみ接続
    for source in current.subtracting(connected) {
        MIDIPortConnectSource(inputPort, source, nil)
    }
}
```

#### 6.3 パフォーマンス改善

**問題:** `handlePacketList`で`Mirror`を使用（リフレクションで重い）

**対策:**
```swift
// Before (重い)
let bytes = Mirror(reflecting: packet.data).children.map { $0.value as! UInt8 }

// After (軽い)
let data: [UInt8] = withUnsafeBytes(of: packet.data) { ptr in
    Array(ptr.prefix(length))
}
```

#### 6.4 deinit での確実な切断

**問題:** actor使用時、deinitで`await`できないため接続状態にアクセスできない

**対策:** `actor` → `NSLock`ベースの`class`に変更

```swift
deinit {
    // 同期アクセス可能
    let connected = connectionState.getConnected()
    for source in connected {
        MIDIPortDisconnectSource(inputPort, source)
    }
    connectionState.clear()
    
    MIDIClientDispose(client)
}
```

### 7. テスト

**48テスト全パス:**

| テストファイル | テスト数 | 内容 |
|---------------|---------|------|
| MUIDTests.swift | 9 | ランダム生成、broadcast/reserved、バイトシリアライズ |
| Mcoded7Tests.swift | 11 | エンコード/デコード、ラウンドトリップ、エッジケース |
| PEChunkAssemblerTests.swift | 7 | シングル/マルチチャンク、ヘッダー保持、タイムアウト |
| PERequestIDManagerTests.swift | 9 | 7-bit制約、順次取得、解放/再利用、ラップアラウンド |
| PETransactionManagerTests.swift | 12 | begin/complete/cancel、タイムアウト、枯渇、診断 |

### 8. ドキュメント

| ファイル | 内容 |
|---------|------|
| README.md | 概要、インストール、**Minimal Example（完全動作コード）**、モジュール説明 |
| Documentation/Architecture.md | モジュール構成図、依存関係、データフロー、Concurrencyモデル |
| Documentation/API.md | 全public APIリファレンス |
| Documentation/BestPractices.md | リーク防止、二重接続防止、エラーハンドリング |

### 9. Git

```bash
# 初期コミット
git init
git add .
git commit -m "Initial commit: MIDI2Kit v0.1.0"

# ドキュメント追加
git commit -m "Add comprehensive documentation"

# GitHubプライベートリポジトリ作成済み
# プッシュ待ち
```

## 成果物

| 項目 | 状態 |
|------|------|
| MIDI2Kit Package | ✅ 作成完了 |
| MIDI2Core | ✅ 実装完了 |
| MIDI2CI | ✅ 実装完了 |
| MIDI2PE | ✅ 実装完了（TransactionManager含む） |
| MIDI2Transport | ✅ 実装完了（差分接続対応） |
| ユニットテスト | ✅ 48テスト全パス |
| ドキュメント | ✅ README + Architecture + API + BestPractices |
| GitHub | ✅ プライベートリポジトリ作成済み |

## 設計判断

| 課題 | 判断 | 理由 |
|------|------|------|
| Request ID管理 | TransactionManager actor | ライフサイクル一元管理でリーク防止 |
| 接続状態管理 | NSLock + class | deinitで同期アクセス必要 |
| パケット処理 | withUnsafeBytes | Mirror使用によるパフォーマンス問題回避 |
| チャンクヘッダー | 最初の非空チャンクを保持 | 一部デバイスが2チャンク目以降でヘッダー省略 |
| タイムアウト | 500ms間隔でcheckTimeouts() | 最終チャンク未着時の確実なタイムアウト発火 |

## KPT

### Keep (継続)
- モジュール分割によるテスタビリティ向上
- 問題発見→対策のドキュメント化
- Minimal Exampleによる使用方法の明確化

### Problem (問題)
- SimpleMIDIControllerとの重複コード（将来的に統合必要）
- 高レベルAPI（CIManager/PEManager）が未実装

### Try (試行)
- 次回: CIManager実装で Discovery 自動化
- SimpleMIDIControllerへのMIDI2Kit統合検討

## 次のステップ

1. **GitHubプッシュ** - リモートURL修正後にプッシュ
2. **CIManager** - Discovery自動化、デバイスライフサイクル管理
3. **PEManager** - GET/SET/Subscribe高レベルAPI
4. **SimpleMIDIControllerへ統合** - 既存アプリでMIDI2Kit使用

## 関連リソース

- MIDI2Kit: `~/Desktop/MIDI2Kit/`
- SimpleMIDIController: `~/Desktop/SimpleMidiController/` (release/1.1.0ブランチ)
